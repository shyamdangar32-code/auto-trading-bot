name: Backtest

on:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/backtest.yml"
      - "bot/**"
      - "tools/**"
      - "strategies/**"
      - "requirements.txt"
      - "config.yaml"
  workflow_dispatch: {}

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        profile: [ loose, medium, strict ]

    env:
      ZERODHA_API_KEY:      ${{ secrets.ZERODHA_API_KEY }}
      ZERODHA_ACCESS_TOKEN: ${{ secrets.ZERODHA_ACCESS_TOKEN }}
      TELEGRAM_BOT_TOKEN:   ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:     ${{ secrets.TELEGRAM_CHAT_ID }}
      UNDERLYING: NIFTY
      INTERVAL: "1m"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compute date range (last 365 days)
        id: dates
        run: |
          END=$(date -u +%F)
          START=$(date -u -d "$END -365 days" +%F)
          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "end=$END" >> "$GITHUB_OUTPUT"

      - name: Run backtest (${{ matrix.profile }})
        run: |
          mkdir -p reports logs
          python -m tools.run_backtest \
            --underlying "${UNDERLYING}" \
            --start "${{ steps.dates.outputs.start }}" \
            --end   "${{ steps.dates.outputs.end }}" \
            --interval "${INTERVAL}" \
            --capital_rs 100000 \
            --order_qty 1 \
            --profile "${{ matrix.profile }}" \
            --outdir "./reports_${{ matrix.profile }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-artifacts-${{ matrix.profile }}
          path: reports_${{ matrix.profile }}/**

      - name: Telegram summary (${{ matrix.profile }})
        if: ${{ success() }}
        env:
          START: ${{ steps.dates.outputs.start }}
          END:   ${{ steps.dates.outputs.end }}
          PROFILE: ${{ matrix.profile }}
        run: |
          python - <<'PY'
          import json, os, pathlib
          prof = os.environ["PROFILE"]
          m = json.load(open(f"reports_{prof}/metrics.json","r",encoding="utf-8"))
          und=os.environ.get("UNDERLYING","NIFTY"); itv=os.environ.get("INTERVAL","1m")
          start=os.environ.get("START",""); end=os.environ.get("END","")
          lines = [
            f"Backtest Summary (SUCCESS) â€” profile: {prof}",
            f"Underlying: {und}   Interval: {itv}",
            f"Period: {start} -> {end}",
            f"Trades: {m.get('n_trades',0)}   Win-rate: {m.get('win_rate',0)}%",
            f"ROI: {m.get('roi_pct',0)}%   PF: {m.get('profit_factor',0)}",
            f"R:R: {m.get('rr',0)}   Sharpe: {m.get('sharpe_ratio',0)}",
            f"Max DD: {m.get('max_dd_pct',0)}%   Time DD: {m.get('time_dd_bars',0)} bars",
            f"Bars: {m.get('n_trades',0) if False else 0}   ATR-bars: 0",  # placeholder to keep your existing format
            f"Setups: long=0 short=0  Trades taken: {m.get('n_trades',0)}",
          ]
          payload = {"chat_id": os.environ["TELEGRAM_CHAT_ID"], "text": "\n".join(lines)}
          pathlib.Path("payload.json").write_text(json.dumps(payload, ensure_ascii=False), encoding="utf-8")
          PY
          curl -s -X POST -H "Content-Type: application/json" \
               -d @payload.json \
               "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" >/dev/null

          for img in equity_curve.png drawdown.png; do
            if [ -f "reports_${PROFILE}/$img" ]; then
              curl -s -F chat_id="${TELEGRAM_CHAT_ID}" \
                      -F photo="@reports_${PROFILE}/$img" \
                "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" >/dev/null
            fi
          done
