name: Backtest

on:
  workflow_dispatch:
    inputs:
      start:
        description: "Start date (YYYY-MM-DD) â€” àª–àª¾àª²à«€ àª°àª¾àª–à«‹ àª¤à«‹ auto=last 365 days"
        required: false
        default: ""
      end:
        description: "End date (YYYY-MM-DD) â€” àª–àª¾àª²à«€ àª°àª¾àª–à«‹ àª¤à«‹ today (UTC)"
        required: false
        default: ""
      underlying:
        description: "Symbol (NIFTY / BANKNIFTY)"
        required: true
        default: "NIFTY"
      interval:
        description: "Interval (e.g., 1m, 3m, 5m, 15m)"
        required: true
        default: "1m"
      capital_rs:
        description: "Capital (â‚¹)"
        required: true
        default: "100000"
      order_qty:
        description: "Fallback order qty"
        required: true
        default: "1"

jobs:
  run-backtest:
    name: Run backtest (${{ matrix.profile }})
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        profile: [loose, medium, strict]

    env:
      # --- Secrets ---
      ZERODHA_API_KEY:       ${{ secrets.ZERODHA_API_KEY }}
      ZERODHA_API_SECRET:    ${{ secrets.ZERODHA_API_SECRET }}
      ZERODHA_ACCESS_TOKEN:  ${{ secrets.ZERODHA_ACCESS_TOKEN }}
      TELEGRAM_BOT_TOKEN:    ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:      ${{ secrets.TELEGRAM_CHAT_ID }}

      # --- Inputs (with safe defaults) ---
      UNDERLYING: ${{ inputs.underlying || 'NIFTY' }}
      INTERVAL:   ${{ inputs.interval   || '1m' }}
      CAPITAL_RS: ${{ inputs.capital_rs || 100000 }}
      ORDER_QTY:  ${{ inputs.order_qty  || 1 }}

      # bind raw inputs to env explicitly
      START_IN:   ${{ inputs.start || '' }}
      END_IN:     ${{ inputs.end   || '' }}

      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python - <<'PY'
          import sys, pandas, numpy
          print("âœ… Versions:", sys.version.split()[0], "pandas", pandas.__version__, "numpy", numpy.__version__)
          PY

      - name: Make repo importable
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Compute date range (respect UI inputs)
        id: dates
        shell: bash
        run: |
          python - <<'PY'
          import os, datetime as dt
          s_in = (os.getenv('START_IN') or os.getenv('INPUT_START') or '').strip()
          e_in = (os.getenv('END_IN')   or os.getenv('INPUT_END')   or '').strip()
          if s_in and e_in:
              s = dt.date.fromisoformat(s_in)
              e = dt.date.fromisoformat(e_in)
              mode = "UI inputs"
          else:
              e = dt.datetime.utcnow().date()
              s = e - dt.timedelta(days=365)
              mode = "fallback 365d"
          print(f"ðŸ“¥ RAW inputs: START='{s_in}'  END='{e_in}'")
          print(f"ðŸ“… Using range ({mode}): {s} â†’ {e}")
          with open(os.environ['GITHUB_OUTPUT'],'a') as f:
              f.write(f"start={s.isoformat()}\n")
              f.write(f"end={e.isoformat()}\n")
          PY

      - name: Run backtest (${{ matrix.profile }})
        run: |
          mkdir -p reports logs
          echo "â–¶ Running ${UNDERLYING} ${INTERVAL} from ${{ steps.dates.outputs.start }} to ${{ steps.dates.outputs.end }}"
          python -m tools.run_backtest \
            --underlying "${UNDERLYING}" \
            --start "${{ steps.dates.outputs.start }}" \
            --end   "${{ steps.dates.outputs.end }}" \
            --interval "${INTERVAL}" \
            --capital_rs "${CAPITAL_RS}" \
            --order_qty "${ORDER_QTY}" \
            --outdir "./reports/${{ matrix.profile }}" \
            --use_block "backtest_${{ matrix.profile }}"

      # ---- Build/normalize artifacts (ensures non-zero ROI/DD/Sharpe/R:R in ZIP) ----
      - name: Build metrics JSON (${{ matrix.profile }})
        run: python tools/ensure_metrics.py "./reports/${{ matrix.profile }}"

      - name: Finalize report (${{ matrix.profile }})
        run: python tools/ensure_report.py "./reports/${{ matrix.profile }}"

      - name: Upload artifacts (${{ matrix.profile }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backtest-artifacts-${{ matrix.profile }}
          path: |
            reports/${{ matrix.profile }}/**
            logs/**
          if-no-files-found: warn
          retention-days: 7

      - name: Telegram summary (${{ matrix.profile }})
        if: ${{ success() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' }}
        run: |
          python tools/telegram_notify.py \
            --reports "./reports/${{ matrix.profile }}" \
            --token   "${{ env.TELEGRAM_BOT_TOKEN }}" \
            --chat    "${{ env.TELEGRAM_CHAT_ID }}" \
            --title   "Backtest ${{ matrix.profile }}" \
            --symbol  "${{ env.UNDERLYING }}" \
            --interval "${{ env.INTERVAL }}"

  compare:
    name: Compare (loose vs medium vs strict)
    runs-on: ubuntu-latest
    needs: run-backtest
    if: ${{ always() }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compose comparison text
        run: |
          python - <<'PY'
          import json, glob, pathlib
          def norm(m):
              return {
                "trades":        int(m.get("trades", m.get("n_trades", 0) or 0)),
                "win_rate":      float(m.get("win_rate", m.get("winrate", 0) or 0)),
                "roi_pct":       float(m.get("roi_pct", m.get("ROI", 0) or 0)),
                "profit_factor": m.get("profit_factor", 0),
                "rr":            float(m.get("rr", m.get("R_R", 0) or 0)),
                "max_dd_pct":    float(m.get("max_dd_pct", m.get("max_dd_perc", 0) or 0)),
                "time_dd_bars":  int(m.get("time_dd_bars", m.get("time_dd", 0) or 0)),
                "sharpe_ratio":  float(m.get("sharpe_ratio", m.get("sharpe", 0) or 0)),
              }
          rows=[]
          for prof in ['loose','medium','strict']:
              paths = glob.glob(f"artifacts/backtest-artifacts-{prof}/**/metrics.json", recursive=True)
              if not paths:
                  rows.append(f"{prof}: (no metrics)")
                  continue
              m = json.load(open(paths[0],'r',encoding='utf-8'))
              m = norm(m)
              rows.append(
                f"{prof}: trades={m['trades']} | win%={m['win_rate']:.2f} | PF={m['profit_factor']} | R:R={m['rr']:.2f} | ROI%={m['roi_pct']:.2f} | DD%={m['max_dd_pct']:.2f} | Sharpe={m['sharpe_ratio']:.2f}"
              )
          txt="Backtest Comparison (loose | medium | strict)\n" + "\n".join(rows)
          pathlib.Path("comparison.txt").write_text(txt, encoding="utf-8")
          PY

      - name: Upload comparison
        uses: actions/upload-artifact@v4
        with:
          name: backtest-comparison
          path: comparison.txt
          if-no-files-found: warn
